#!/usr/bin/env ruby

require "bundler/setup"

require "deep_cover"
require_relative "../spec/tools"

def show_builtin(fn)
  puts format(fn, builtin_coverage(fn))
end

def show_our_cov(fn)
  puts format(fn, our_coverage(fn))
end

example = ARGV[0] || 'simple_if'
fn = "./spec/samples/#{example}.rb"
puts "Builtin:\n"
show_builtin(fn)
puts "\nPure Ruby:\n"
cover = show_our_cov(fn)
puts "\nGenerated code:\n"
buffer = DeepCover.buffer(fn)
puts buffer.covered_source
puts "\nParsed code:\n"
puts buffer.ast
puts "\nBranch coverage:\n"

bc = buffer.branch_cover
require 'term/ansicolor'
o = buffer.source_lines.map.with_index do |line, line_index|
  line.chars.map.with_index do |c, c_index|
    color = bc[line_index][c_index] == ' ' ? :green : :red
    Term::ANSIColor.send(color, c)
  end.join
end
puts o
