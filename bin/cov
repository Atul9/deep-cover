#!/usr/bin/env ruby

require "bundler/setup"

require "deep_cover"
require_relative "../spec/tools"

def show_builtin(fn)
  puts format(fn, builtin_coverage(fn))
end

def show_our_cov(fn)
  puts format(fn, our_coverage(fn))
end

example = ARGV[0] || 'simple_if'
fn = "./spec/samples/#{example}.rb"
puts "Builtin:\n"
show_builtin(fn)
puts "\nPure Ruby:\n"
cover = show_our_cov(fn)
puts "\nGenerated code:\n"
context = DeepCover.context(fn)
puts context.covered_source
puts "\nParsed code:\n"
puts context.ast
puts "\nBranch coverage:\n"

bc = context.branch_cover
require 'term/ansicolor'
COLOR = {'x' => :red, ' ' => :green, '.' => :faint}
o = context.buffer.source_lines.map.with_index do |line, line_index|
  line.chars.map.with_index do |c, c_index|
    color = COLOR[bc[line_index][c_index]]
    Term::ANSIColor.send(color, c)
  end.join
end
puts o
