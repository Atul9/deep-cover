#!/usr/bin/env ruby

require "bundler/setup"

require "deep_cover"
require_relative "../spec/tools"
require 'term/ansicolor'
extend DeepCover::Tools

def show_builtin(fn)
  puts format(fn, builtin_coverage(fn))
end

def show_our_cov(fn)
  puts format(fn, our_coverage(fn))
end

example = ARGV[0] || 'simple_if'
fn = "./spec/samples/#{example}.rb"
fn = "./spec/branch_cover/#{example}.rb" unless File.exist?(fn)
source = File.exist?(fn) ? File.read(fn) : ARGV[0]
groups = DeepCover::Tools::AnnotatedExamplesParser.process(source)
if groups.size == 1 && groups.first.last.size == 1
  lines = groups.values.first.values.first
else
  menu = []
  item = -1
  examples = groups.flat_map do |title, examples|
    menu << Term::ANSIColor.green(title) if title
    menu.concat(examples.keys.map {|ex| "  #{item+=1}: #{ex || '(General)'}"})
    examples.values
  end
  if ARGV[1]
    answer = ARGV[1].to_i
  else
    require 'highline'
    puts menu
    answer = HighLine.new.ask(Term::ANSIColor.blue("Which?  "), Integer) { |q| q.in = 0...examples.size }
  end
  lines = examples[answer]
end

require 'tempfile'
tmp = Tempfile.new(['example', '.rb'])
fn = tmp.path
File.write(fn, lines.join)

puts "Builtin:\n"
show_builtin(fn)
puts "\nPure Ruby:\n"
cover = show_our_cov(fn)
puts "\nGenerated code:\n"
context = DeepCover.context(fn)

puts format_generated_code(context)
puts "\nParsed code:\n"

module ColorAST
  def fancy_type
    color = case
    when !executable?
      :faint
    when !was_executed?
      :red
    else
      :green
    end
    Term::ANSIColor.send(color, super)
  end
end
DeepCover::Node.send :prepend, ColorAST

puts context.covered_ast
puts "\nBranch coverage:\n"

puts format_branch_cover(context, show_whitespace: !!ENV['W'])

a = context.covered_ast
b = a.children.first
binding.pry
