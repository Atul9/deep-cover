#!/usr/bin/env ruby
require "bundler/setup"
require "pry"
require_relative "../spec/self_coverage_tools"
extend DeepCover::Tools

covered_path = ARGV[0]
if covered_path
  $LOAD_PATH.unshift(covered_path)
end
require "deep_cover"

if covered_path.nil?
  covered_path = dump_covered_code('./lib', '../covered_deep_cover')
  puts "Covered code generation done. Output in", covered_path
  exec 'bin/selfcov', covered_path
else
  coverage = load_covered_sources(covered_path)
  require 'rspec'
  error = RSpec::Core::Runner::run(Dir.glob('./spec/*_spec.rb'))
  puts "Lines not covered:", coverage.report
  binding.pry
end
